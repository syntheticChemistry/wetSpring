# Galaxy Project — Self-Hosted on Eastgate
#
# Provides a full Galaxy bioinformatics platform with:
# - Galaxy web UI on port 8080
# - PostgreSQL 15 database (persistent)
# - Persistent data volumes for datasets, tools, and workflows
#
# Usage:
#   cd wetSpring/control/galaxy
#   docker compose up -d
#   # Access: http://localhost:8080
#   # Default admin: admin@galaxy.org / admin (change immediately)
#
# Requirements:
#   - Docker 20.10+ with compose v2
#   - ~10 GB disk for initial image + tools
#   - ~4 GB RAM minimum (8+ recommended for NGS pipelines)
#
# Galaxy 24.1 (Nov 2024) — Ubuntu 22.04, Python 3.10, PostgreSQL 15
# Upgraded from 20.09 to support modern toolshed revisions (QIIME2, Kraken2, etc.)

services:
  galaxy:
    image: quay.io/bgruening/galaxy:24.1
    container_name: wetspring-galaxy
    restart: unless-stopped
    ports:
      - "8080:80"       # Galaxy web interface
      - "8021:21"       # FTP upload
      - "8022:22"       # SFTP upload
    volumes:
      - galaxy-data:/export     # Persistent Galaxy data (datasets, DBs, configs)
      - ./tool_lists:/tool_lists:ro  # Custom tool install lists
      - /var/run/docker.sock:/var/run/docker.sock:rw  # Host Docker for QIIME2 containers
    environment:
      - GALAXY_CONFIG_BRAND=wetSpring
      - GALAXY_CONFIG_ADMIN_USERS=admin@galaxy.org
      - GALAXY_CONFIG_ALLOW_USER_CREATION=True
      - GALAXY_CONFIG_ALLOW_USER_DATASET_PURGE=True
      - GALAXY_CONFIG_ENABLE_QUOTAS=False
      - GALAXY_CONFIG_CLEANUP_JOB=onsuccess
      - GALAXY_CONFIG_RETRY_METADATA_INTERNALLY=True
      - GALAXY_CONFIG_MASTER_API_KEY=wetspring-bootstrap-key-2026
    deploy:
      resources:
        limits:
          memory: 16G
        reservations:
          memory: 4G

volumes:
  galaxy-data:
    driver: local
